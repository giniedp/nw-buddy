<ion-split-pane [when]="pinMenu()" contentId="zone-map-content" style="--side-max-width: 500px">
  <div class="ion-page" id="zone-map-content">
    <ion-header>
      <ion-toolbar class="bg-base-300">
        <div slot="start">
          <ion-buttons slot="start">
            @if (!pinMenu()) {
              <ng-container [ngTemplateOutlet]="tplMenuStart" />
              <button class="btn btn-square btn-ghost" (click)="menu.toggle()">
                <nwb-icon [icon]="filterIcon" class="w-5 h-5" />
              </button>
            }
          </ion-buttons>
        </div>
        <div slot="end">
          <div class="flex flex-row items-center gap-2">
            @if (showMapOptions()) {
              <select
                [ngModel]="store.mapId()"
                (ngModelChange)="handleMapIdSelected($event)"
                class="select select-sm w-60"
              >
                @for (category of mapsOptions(); track category.name) {
                  <optgroup [label]="category.name">
                    @for (option of category.options; track option.id) {
                      <option [value]="option.id">{{ option.name | nwText }}</option>
                    }
                  </optgroup>
                }
              </select>
            }
            <button class="join-item btn btn-square btn-ghost" [cdkMenuTriggerFor]="tplConfigMenu">
              <nwb-icon [icon]="toolsIcon" class="w-5 h-5" />
            </button>
          </div>

          <ng-template #tplConfigMenu>
            <div class="bg-base-200 border border-base-100 w-80 rounded-b-md z-10 p-2 flex flex-col" cdkMenu>
              <label class="label">
                <input
                  class="toggle checked:toggle-primary"
                  type="checkbox"
                  [ngModel]="store.showLabels()"
                  (ngModelChange)="store.setLabels($event)"
                />
                Territory labels
              </label>

              <label class="label">
                <input
                  class="toggle checked:toggle-primary"
                  type="checkbox"
                  [ngModel]="store.showHeatmap()"
                  (ngModelChange)="store.setHeatmap($event)"
                />
                Heatmap
              </label>

              <label class="label">
                <input
                  class="toggle checked:toggle-primary"
                  type="checkbox"
                  [ngModel]="store.showZoneConfigs()"
                  (ngModelChange)="store.setZoneConfigs($event)"
                />
                Region & refresh bounds
              </label>
              <label class="label">
                <input
                  class="toggle checked:toggle-primary"
                  type="checkbox"
                  [ngModel]="store.showTractmap()"
                  (ngModelChange)="store.setTractmap($event)"
                />
                Tractmap
              </label>
            </div>
          </ng-template>
        </div>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <nwb-map
        class="ion-page"
        [mapId]="store.mapId()"
        [zoneId]="zoneId()"
        [territories]="store.territories()"
        [areas]="store.areas()"
        [pois]="store.showPOI() ? store.pois() : null"
        [tractmap]="store.showTractmap()"
        [labels]="store.showLabels()"
        (zoneClick)="zoneClicked.emit($event)"
      />

      <game-map-coords
        [nwbGameMapControl]="'top-left'"
        [style.order]="-1"
        class="text-nowrap text-shadow-sm shadow-black font-mono text-sm"
      />

      @if (store.isOpenWorld()) {
        <ng-container
          [nwbMapLayer]="'zoneConfigs'"
          [data]="store.zoneConfigs()"
          [disabled]="!store.showZoneConfigs()"
          [color]="'#FF00FF'"
          [outline]="true"
          [outlineDashed]="true"
          [polygons]="true"
          [polyOpacity]="0"
          [minZoom]="15"
          (featureMouseEnter)="handleMouseEnterZoneConfig($event)"
          (featureMouseMove)="handleMouseMoveZoneConfig($event)"
          (featureMouseLeave)="handleMouseLeaveZoneConfig($event)"
        />
        <ng-container
          [nwbMapLayer]="'regionBounds'"
          [data]="store.regionBounds()"
          [disabled]="!store.showZoneConfigs()"
          [color]="'#008080'"
          [labels]="true"
          [outline]="true"
          [polygons]="true"
          [polyOpacity]="0"
          [labelsMinZoom]="0"
          [labelsMaxZoom]="15"
          [maxZoom]="15"
        />
      }

      @if (hoverZoneConfigs()?.length) {
        <ul *nwbGameMapMouseTip class="men menu-sm rounded-sm bg-base-200 pb-1 mb-1">
          @for (item of hoverZoneConfigs(); track item.name) {
            <li>
              <nwb-property-grid [item]="item.data" class="gap-x-2" />
            </li>
          }
        </ul>
      }
    </ion-content>
  </div>
  <ion-menu
    contentId="zone-map-content"
    [menuId]="'zone-map-filter'"
    #menu
    style="--width: calc(max(100vw, 400px)); --max-width: 500px"
  >
    <ion-header>
      <ion-toolbar class="bg-base-300">
        <ion-buttons slot="start">
          @if (!pinMenu()) {
            <button (click)="menu.toggle()" class="btn btn-square btn-ghost">
              <nwb-icon [icon]="filterIcon" class="w-5 h-5" />
            </button>
          } @else {
            <ng-container [ngTemplateOutlet]="tplMenuStart" />
          }
        </ion-buttons>
        <ion-segment [value]="segment()">
          @for (segment of segments(); track $index) {
            <ion-segment-button (click)="selectSegment(segment.id)" [value]="segment.id">
              <nwb-icon [icon]="segment.icon" class="w-5 h-5" />
              <span>{{ segment.label }}</span>
            </ion-segment-button>
          }
        </ion-segment>
      </ion-toolbar>
    </ion-header>
    <ion-content class="bg-base-200/80">
      @if (!store.isLoaded()) {
        <div class="flex items-center justify-center p-4">
          <span class="loading loading-spinner loading-sm"></span>
        </div>
      }
      @if (activeSegment(); as segment) {
        @if (segment.source) {
          <nwb-map-filter-segment [source]="segment.source" [open]="segment.open" />
        }
        @if (segment.vitals) {
          <nwb-map-filter-vitals [data]="segment.vitals" />
        }
      }
    </ion-content>
  </ion-menu>
</ion-split-pane>

<ng-template #tplMenuStart>
  <ng-content [selector]="'[menu-start]'" />
</ng-template>
